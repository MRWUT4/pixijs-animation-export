(function(window){window.aape=window.aape||{};window.aape.EventDispatcher=EventDispatcher;var prototype=EventDispatcher.prototype=Object.create(Object.prototype);prototype.constructor=EventDispatcher;function EventDispatcher(){Object.call(this);this.eventLibrary={}}prototype.on=function(type,callbackFunction,scope){this.addEventListener(type,callbackFunction,scope)};prototype.off=function(type,callbackFunction,scope){this.removeEventListener(type,callbackFunction,scope)};prototype.send=function(event,currentTarget){this.dispatchEvent(event,currentTarget)};prototype.mute=function(){this.removeAllEventListeners()};prototype.addEventListener=function(type,callbackFunction,scope){var object={type:type,target:this,callbackFunction:callbackFunction,scope:scope};var list=this.getListWithType(type);var isInList=this.objectIsInList(list,object);if(list.length==0||!isInList){list.push(object);this.eventLibrary[type]=list}};prototype.removeEventListener=function(type,callbackFunction,scope){var list=this.getListWithType(type);for(var i=list.length-1;i>=0;--i){var object=list[i];var hasCorrectType=object.type==type;var hasNoOrMatchingCallback=!callbackFunction||object.callbackFunction==callbackFunction;var hasCorrectScope=object.scope==scope;if(hasCorrectType&&hasNoOrMatchingCallback&&hasCorrectScope)list.splice(i,1)}this.eventLibrary[type]==list};prototype.removeAllEventListeners=function(){this.eventLibrary={}};prototype.dispatchEvent=function(event,currentTarget){var list=this.getListWithType(event.type);for(var i=list.length-1;i>=0;--i){var object=list[i];if(object){event.currentTarget=currentTarget||event.target||null;event.target=object.target;event.callbackFunction=object.callbackFunction;if(object.callbackFunction){if(object.scope)object.callbackFunction.call(object.scope,event);else object.callbackFunction(event)}else console.log('Error: callbackFunction for "'+event.type+'" event not defined.')}}};prototype.getListWithType=function(type){var list=this.eventLibrary[type];list=list==undefined?[]:this.eventLibrary[type];return list};prototype.objectIsInList=function(list,object){var bool=true;for(var i=0;i<list.length;++i){var listObject=list[i];if(!this.compareEvents(listObject,object)){bool=false;break}}return bool};prototype.compareEvents=function(event0,event1){var bool=true;if(event0!=undefined&&event1!=undefined){var isIdenticalType=event0.type==event1.type;var isIdenticalCallback=event0.callbackFunction==event1.callbackFunction;var isIdenticalScope=event0.scope==event1.scope;if(!isIdenticalType||!isIdenticalCallback||!isIdenticalScope)bool=false}return bool}})(window);(function(window){Event.prototype=new Object;Event.ACTIVE="active";Event.ADD="add";Event.ADDED="added";Event.ANIMATION_END="animationend";Event.AUDIO_COMPLETE="audioComplete";Event.AUDIO_PAUSE="audioPause";Event.AUDIO_PLAY="audioPlay";Event.BLUR="blur";Event.CALL="call";Event.CANVAS_RESIZE="canvasresize";Event.CHANGE="change";Event.CLICK="click";Event.CLOSE="close";Event.CLOSED="closed";Event.COMPLETE="complete";Event.CONNECT="connnect";Event.END="end";Event.ENTER="enter";Event.ERROR="error";Event.EXIT="exit";Event.FAIL="fail";Event.FOCUS="focus";Event.GYRO="gyro";Event.HIDE="hide";Event.HIT="hit";Event.INACTIVE="inactive";Event.INDEX="index";Event.INIT="init";Event.KEY="key";Event.KILL="kill";Event.LOAD="load";Event.LOADED="loaded";Event.LOCK="lock";Event.MESSAGE="message";Event.MOUSE_DOWN="mousedown";Event.MOUSE_MOVE="mousemove";Event.MOUSE_OUT="mouseout";Event.MOUSE_OVER="mouseover";Event.MOUSE_UP="mouseup";Event.MOUSE_UP_OUTSIDE="mouseupoutside";Event.NEXT="next";Event.OPEN="open";Event.PAUSE="pause";Event.PLAY="play";Event.PRESS_DOWN="pressdown";Event.PRESS_MOVE="pressmove";Event.PRESS_UP="pressup";Event.PREVIOUS="previous";Event.PROCESS="process";Event.PROGRESS="progress";Event.READY="ready";Event.REMOVE="remove";Event.REMOVED="removed";Event.RESET="reset";Event.RESIZE="resize";Event.SEND="send";Event.SETUP="setup";Event.SHOW="show";Event.SPAWN="spawn";Event.START="start";Event.STARTED="started";Event.STEP="step";Event.STOP="stop";Event.SUCCESS="success";Event.TOUCH_END="touchend";Event.TOUCH_END_OUTSIDE="touchendoutside";Event.TOUCH_MOVE="touchmove";Event.TOUCH_START="touchstart";Event.UNLOCK="unlock";Event.UPDATE="update";Event.VALIDATE="validate";function Event(type,object){this.type=type;this.object=object;this.callbackFunction=null;this.target=null;this.currentTarget=null}window.Event=Event})(window);(function(window){window.aape=window.aape||{};window.aape.Loader=Loader;var prototype=Loader.prototype=Object.create(aape.EventDispatcher.prototype);prototype.constructor=Loader;Loader.POOL=Loader.POOL||[];Loader.REGEX_FILE=/([^"]+(?=\.(jpg|gif|png|json|js|wav|mp3|ogg))\.\2)/gm;function Loader(setup){aape.EventDispatcher.call(this);this.setup=setup||{};this.recursion=this.setup.recursion||1;this.static=this.setup.static||true;this.ignoreRecursionProgressDepth=this.setup.ignoreRecursionProgressDepth||1;this.maxCueSize=this.setup.maxCueSize||4;this.forceURLImage=this.setup.forceURLImage||true;this.suffix=this.setup.suffix||"";this.numItems=0}Loader.getNormalizedURL=function(url){var split=typeof url=="string"?url.split("\\").join("/"):"";return split};Loader.getValueIsURL=function(value){return typeof value=="string"?value.match(Loader.REGEX_FILE):false};Object.defineProperty(prototype,"results",{get:function(){var list=[];for(var i=0;i<this.loadItems.length;++i){var loadItem=this.loadItems[i];list.push(loadItem.result)}return list}});Object.defineProperty(prototype,"loadItems",{get:function(){if(this.static)return Loader.POOL;else{this._loadItems=this._loadItems!==undefined?this._loadItems:[];return this._loadItems}}});Object.defineProperty(prototype,"list",{get:function(){this._list=this._list||[];return this._list}});Object.defineProperty(prototype,"pool",{get:function(){this._pool=this._pool||[];return this._pool}});Object.defineProperty(prototype,"progress",{get:function(){var total=0;var numIgnores=0;var length=this.pool.length;for(var i=0;i<length;++i){var loadItem=this.pool[i];if(loadItem.startRecursion!==this.ignoreRecursionProgressDepth)total+=loadItem.progress;else numIgnores++}var progress=Math.min(1,total/(length-numIgnores-1));progress=progress||0;return progress}});Object.defineProperty(prototype,"ignore",{get:function(){return this._ignore||[]},set:function(value){this._ignore=value}});prototype.getProgress=function(){return this.progress};prototype.getObjectWithID=function(id){return this.getLoadItemsWithID(id)[0]};prototype.getObjectsWithID=function(id){return this.getLoadItemsWithID(id)};prototype.getLoadItemsWithID=function(id){return this.getItemsInArrayWithId(this.loadItems,id)};prototype.getItemsInArrayWithId=function(array,id){var list=[];if(id){for(var i=0;i<array.length;++i){var loadItem=array[i];var loadItemURL=this.removeSuffix(Loader.getNormalizedURL(loadItem.id));var idURL=this.removeSuffix(Loader.getNormalizedURL(id));var hasMatch=loadItemURL==idURL;if(hasMatch)list.push(loadItem)}}return list};prototype.isIgnoredFileType=function(object){for(var i=0;i<this.ignore.length;++i){var ignored=this.ignore[i];if(object.match(ignored))return true}return false};prototype.reset=function(){this._pool=[];this._list=[];this._ignore=[]};prototype.createLoadItem=function(url,recursion){var type=url.split(".")[1].split("?")[0].split("#")[0];var item=null;switch(type){case aape.LoadItemJSON.TYPE_JSON:item=new aape.LoadItemJSON(recursion);break;case aape.LoadItemImage.TYPE_PNG:case aape.LoadItemImage.TYPE_JPG:case aape.LoadItemImage.TYPE_GIF:item=new aape.LoadItemImage(recursion,this.forceURLImage);break;case aape.LoadItemAudio.TYPE_MP3:case aape.LoadItemAudio.TYPE_OGG:case aape.LoadItemAudio.TYPE_WAV:item=new aape.LoadItemAudio(recursion);break;case aape.LoadItemJS.TYPE_JS:item=new aape.LoadItemJS(recursion);break}return item};prototype.addSuffix=function(url){return this.suffix!==undefined?url+this.suffix:url};prototype.removeSuffix=function(url){return url.split(this.suffix).join("")};prototype.load=function(manifest){this.manifest=manifest instanceof Array?manifest:[manifest];this.loadData(this.manifest,this.recursion)};prototype.loadArray=function(object,recursion){for(var i=0;i<object.length;++i){var url=object[i];this.loadData(url,recursion)}this.loadNextItem()};prototype.loadObject=function(object,recursion){for(var property in object){var value=object[property];switch(typeof value){case"object":this.loadObject(value,recursion);break;case"string":var splitManifest=value.split("manifest:");if(splitManifest.length>1)value=splitManifest[1].split("};")[0];var match=Loader.getValueIsURL(value);if(match)this.loadData(match,recursion);break}}this.loadNextItem()};prototype.loadData=function(object,recursion){if(object instanceof Array)this.loadArray(object,recursion);else if(object instanceof Object)this.loadObject(object,recursion);else if(object){this.numItems++;var loadItem=this.createLoadItem(object,recursion);if(loadItem){var ignored=this.isIgnoredFileType(object);if(!ignored){loadItem.on(Event.PROGRESS,this.loadItemProgressHandler,this);loadItem.on(Event.PROCESS,this.loadItemProcessHandler,this);loadItem.on(Event.COMPLETE,this.loadItemCompleteHandler,this);loadItem.url=Loader.getNormalizedURL(object);loadItem.url=this.addSuffix(loadItem.url);this.send(new Event(Event.ADD,loadItem));this.pool.push(loadItem);this.list.push(loadItem)}}}else this.loadNextItem()};prototype.loadNextItem=function(){var size=this.maxCueSize||this.list.length;for(var i=0;i<size;++i){var loadItem=this.list[i];if(loadItem&&!loadItem.isLoading)loadItem.load(loadItem.url)}};prototype.loadItemProgressHandler=function(event){var loadItem=event.target;this.send(new Event(Event.PROGRESS,this.progress))};prototype.loadItemProcessHandler=function(event){var loadItem=event.target;this.send(new Event(Event.PROCESS,loadItem))};prototype.loadItemCompleteHandler=function(event){var loadItem=event.target;this.addItemToGlobalPool(loadItem);this.recurseLoadResult(loadItem);this.removeItemFromArray(this.list,loadItem);this.dispatchLoadAndCompleteEvents(loadItem);this.loadNextItem()};prototype.addItemToGlobalPool=function(loadItem){if(!this.getObjectWithID(loadItem.id))this.loadItems.push(loadItem)};prototype.recurseLoadResult=function(loadItem){if(loadItem.recurse)this.loadData(loadItem.result,loadItem.recursion-1)};prototype.removeItemFromArray=function(array,loadItem){for(var i=array.length-1;i>=0;--i){if(array[i]==loadItem)array.splice(i,1)}};prototype.dispatchLoadAndCompleteEvents=function(loadItem){this.send(new Event(Event.LOAD,loadItem));if(this.list.length==0)this.send(new Event(Event.COMPLETE))}})(window);(function(window){window.aape=window.aape||{};window.aape.URLRequest=URLRequest;var prototype=URLRequest.prototype=Object.create(aape.EventDispatcher.prototype);prototype.constructor=URLRequest;function URLRequest(){aape.EventDispatcher.call(this);this.mimeType=null;this.responseType=null}Object.defineProperty(prototype,"progress",{get:function(){return this._progress||0},set:function(value){this._progress=value}});Object.defineProperty(prototype,"data",{get:function(){this._data=this._data||this.request.response||this.request.responseText;return this._data},set:function(value){this._data=value}});prototype.load=function(url){this.url=url;URLRequest.getXMLHttpRequestAndCall(this.xmlHttpCallbackHandler.bind(this))};prototype.xmlHttpCallbackHandler=function(request){this.request=request;if(this.request.addEventListener){this.request.addEventListener(Event.PROGRESS,this.requestProgressHandler.bind(this));this.request.addEventListener(Event.LOAD,this.requestLoadHandler.bind(this))}else this.request.onreadystatechange=this.requestOnReadyStateChangeHandler.bind(this);if(this.request.overrideMimeType&&this.mimeType){this.request.overrideMimeType(this.mimeType);this.openAndSendRequest()}else if(this.mimeType==null)this.openAndSendRequest();else this.dispatchEvent(new Event(Event.ERROR))};prototype.openAndSendRequest=function(){this.request.open("GET",this.url,true);try{if(this.responseType)this.request.responseType=this.responseType}catch(error){}this.request.send()};prototype.requestProgressHandler=function(event){this.progress=event.loaded/event.total;this.dispatchEvent(new Event(Event.PROGRESS))};prototype.requestLoadHandler=function(event){this.progress=1;this.dispatchEvent(new Event(Event.PROGRESS));this.dispatchEvent(new Event(Event.COMPLETE))};prototype.requestOnReadyStateChangeHandler=function(){switch(this.request.readyState){case 4:this.requestLoadHandler(null);break}};URLRequest.getXMLHttpRequestAndCall=function(callback){var request=null;try{request=new XMLHttpRequest;callback(request)}catch(error){try{request=new window.ActiveXObject("Msxml2.XMLHTTP");callback(request)}catch(error){request=new window.ActiveXObject("Microsoft.XMLHTTP");callback(request)}}return request}})(window);(function(window){window.aape=window.aape||{};window.aape.LoadItem=LoadItem;var prototype=LoadItem.prototype=Object.create(aape.EventDispatcher.prototype);prototype.constructor=LoadItem;LoadItem.TYPE_FILE="file";function LoadItem(recursion){aape.EventDispatcher.call(this);this.type=LoadItem.TYPE_FILE;this.startRecursion=recursion;this.recursion=recursion}Object.defineProperty(prototype,"id",{get:function(){return this.url}});Object.defineProperty(prototype,"name",{get:function(){return this.id.split("/").slice(-1).join().split(".")[0]}});Object.defineProperty(prototype,"recurse",{get:function(){return this.recursion>=0||this.recursion===null}});Object.defineProperty(prototype,"progress",{get:function(){var progress=this.urlRequest?this.urlRequest.progress:this._progress;progress=progress===undefined?0:progress;return progress},set:function(value){this._progress=value}});Object.defineProperty(prototype,"result",{get:function(){return null}});Object.defineProperty(prototype,"url",{get:function(){return this._url},set:function(value){this._url=value}});prototype.load=function(url){this.url=url;this.isLoading=true;this.urlRequest=new aape.URLRequest;this.urlRequest.addEventListener(Event.PROGRESS,this.urlRequestProgressHandler.bind(this));this.urlRequest.addEventListener(Event.COMPLETE,this.urlRequestCompleteHandler.bind(this));this.urlRequest.load(this.url)};prototype.urlRequestProgressHandler=function(event){this.dispatchEvent(event)};prototype.urlRequestCompleteHandler=function(event){this.decreaseRecursion();this.dispatchEvent(event)};prototype.decreaseRecursion=function(){if(this.recursion)this.recursion--}})(window);(function(window){window.aape=window.aape||{};window.aape.LoadItemJSON=LoadItemJSON;var prototype=LoadItemJSON.prototype=Object.create(aape.LoadItem.prototype);prototype.constructor=LoadItemJSON;LoadItemJSON.TYPE_JSON="json";LoadItemJSON.ERROR_IVALIDJSON="Invalid JSON file: ";function LoadItemJSON(recursion){aape.LoadItem.call(this,recursion);this.type=LoadItemJSON.TYPE_JSON}prototype.urlRequestCompleteHandler=function(event){this.decreaseRecursion();this.dispatchEvent(new Event(Event.PROCESS));this.dispatchEvent(event)};Object.defineProperty(prototype,"result",{get:function(){try{var data=this.urlRequest.data;var json=data?JSON.parse(data):null}catch(error){console.log(LoadItemJSON.ERROR_IVALIDJSON+this.url)}return json}})})(window);(function(window){window.aape=window.aape||{};window.aape.LoadItemImage=LoadItemImage;var prototype=LoadItemImage.prototype=Object.create(aape.LoadItem.prototype);prototype.constructor=LoadItemImage;LoadItemImage.TYPE_IMAGE="image";LoadItemImage.TYPE_PNG="png";LoadItemImage.TYPE_JPG="jpg";LoadItemImage.TYPE_GIF="gif";LoadItemImage.MIME_TYPE="text/plain; charset=x-user-defined";function LoadItemImage(recursion,forceURLImage){aape.LoadItem.call(this,recursion);this.type=LoadItemImage.TYPE_IMAGE;this.forceURLImage=forceURLImage||false}Object.defineProperty(prototype,"result",{get:function(){return this._result},set:function(value){this._result=value}});Object.defineProperty(prototype,"recurse",{get:function(){return false}});prototype.load=function(url){this.url=url;this.isLoading=true;var urlSplit=url.split(".");this.suffix=urlSplit[urlSplit.length-1];if(this.forceURLImage)this.urlRequestErrorHandler();else{this.urlRequest=new aape.URLRequest;this.urlRequest.mimeType=LoadItemImage.MIME_TYPE;this.urlRequest.addEventListener(Event.PROGRESS,this.urlRequestProgressHandler.bind(this));this.urlRequest.addEventListener(Event.COMPLETE,this.urlRequestCompleteHandler.bind(this));this.urlRequest.addEventListener(Event.ERROR,this.urlRequestErrorHandler.bind(this));this.urlRequest.load(url)}};prototype.urlRequestErrorHandler=function(event){var image=new Image;image.onload=function(){this.result=image;this.progress=1;this.dispatchEvent(new Event(Event.PROCESS));this.dispatchEvent(new Event(Event.PROGRESS));this.dispatchEvent(new Event(Event.COMPLETE))}.bind(this);image.src=this.url};prototype.urlRequestCompleteHandlerLoaderItem=prototype.urlRequestCompleteHandler;prototype.urlRequestCompleteHandler=function(event){this.dispatchEvent(new Event(Event.PROCESS));this.createImageDataObject(event)};prototype.createImageDataObject=function(event){var dataUTF8=Base64.encode(this.urlRequest.data);var image=new Image;image.onload=function(){this.result=image;this.dispatchEvent(event)}.bind(this);image.src="data:image/"+this.suffix+";base64,"+dataUTF8}})(window);(function(window){window.aape=window.aape||{};window.aape.LoadItemAudio=LoadItemAudio;var prototype=LoadItemAudio.prototype=Object.create(aape.LoadItem.prototype);prototype.constructor=LoadItemAudio;LoadItemAudio.TYPE_AUDIO="audio";LoadItemAudio.TYPE_MP3="mp3";LoadItemAudio.TYPE_M4A="m4a";LoadItemAudio.TYPE_OGG="ogg";LoadItemAudio.TYPE_WAV="wav";LoadItemAudio.RESPONSE_TYPE="arraybuffer";LoadItemAudio.RESPONSE_TYPE_BLOB="blob";LoadItemAudio.TYPE_LIST=["m4a","mp3","ogg","wav"];function LoadItemAudio(recursion){aape.LoadItem.call(this,recursion);this.type=LoadItemAudio.TYPE_AUDIO;this.audioContext=window.Jukebox?Jukebox.audioContext:null;this.ignoreSoundOnMobile=window.Jukebox&&Jukebox.getInstance().getIgnoreSoundOnMobile();this.loadedDataCallback=this.audioLoadedDataHandler.bind(this)}Object.defineProperty(prototype,"result",{get:function(){return this._result},set:function(value){this._result=value}});Object.defineProperty(prototype,"recurse",{get:function(){return false}});prototype.load=function(url){this.url=url;this.isLoading=true;var urlSplit=url.split(".");this.suffix=urlSplit[urlSplit.length-1];if(System.isMobile.any()&&this.ignoreSoundOnMobile){this.progress=1;this.dispatchEvent(new Event(Event.PROGRESS));this.dispatchEvent(new Event(Event.COMPLETE))}else if(this.audioContext)this.loadRequest(url);else this.loadElement(url)};prototype.loadRequest=function(url){this.urlRequest=new aape.URLRequest;this.urlRequest.responseType=LoadItemAudio.RESPONSE_TYPE;this.urlRequest.addEventListener(Event.PROGRESS,this.urlRequestProgressHandler.bind(this));this.urlRequest.addEventListener(Event.COMPLETE,this.urlRequestCompleteHandler.bind(this));this.urlRequest.load(url)};prototype.urlRequestCompleteHandlerLoaderItem=prototype.urlRequestCompleteHandler;prototype.urlRequestCompleteHandler=function(event){this.audioContext.decodeAudioData(this.urlRequest.data,this.contextOnBufferHandler.bind(this))};prototype.contextOnBufferHandler=function(buffer){this.result=buffer;this.dispatchEvent(new Event(Event.COMPLETE))};prototype.loadElement=function(url){this.audio=new Audio;this.audio.preload="auto";this.audio.src=url;this.audio.load();this.audio.pause();this.audio.addEventListener("canplaythrough",this.loadedDataCallback);this.audio.addEventListener("error",this.audioOnErrorHandler.bind(this))};prototype.audioOnErrorHandler=function(event){this.audioLoadedDataHandler()};prototype.audioLoadedDataHandler=function(event){this.audio.removeEventListener("canplaythrough",this.loadedDataCallback);this.progress=1;this.dispatchEvent(new Event(Event.PROGRESS));this.contextOnBufferHandler(this.audio)}})(window);(function(window){window.aape=window.aape||{};window.aape.LoadItemJS=LoadItemJS;var prototype=LoadItemJS.prototype=Object.create(aape.LoadItem.prototype);prototype.constructor=LoadItemJS;LoadItemJS.TYPE_JS="js";LoadItemJS.TAG_TYPE="text/javascript";function LoadItemJS(recursion){aape.LoadItem.call(this,recursion);this.type=LoadItemJS.TYPE_JS}Object.defineProperty(prototype,"result",{get:function(){return this._result},set:function(value){this._result=value}});prototype.urlRequestCompleteHandlerLoadItem=prototype.urlRequestCompleteHandler;prototype.urlRequestCompleteHandler=function(event){this.appendJSFile(this.url)};prototype.appendJSFile=function(url){this.scriptTag=document.createElement("script");this.scriptTag.type=LoadItemJS.TAG_TYPE;this.result={data:this.urlRequest.data};this.dispatchEvent(new Event(Event.PROCESS));this.scriptTag.text=this.result.data;var head=document.getElementsByTagName("head")[0];head.appendChild(this.scriptTag);this.dispatchEvent(new Event(Event.PROGRESS));this.dispatchEvent(new Event(Event.COMPLETE))}})(window);